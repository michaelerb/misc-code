<!DOCTYPE html>
<html lang='en'>

  <head>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/chartjs=plugin-colorschemes/0.4.0/chartjs=plugin-colorschemes.min.js"></script>-->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </head>

  <body>

    <div style='height:300px'><canvas id='ts_chart'></canvas></div>
    <div style='float:right' id='buttons'></div>

    <script>

      // Get parameters from the URL
      var url_string = window.location.search;
      var url_vars = new URLSearchParams(url_string);
      var filename  = url_vars.get('filename');

      // Load data
      var filename_txt = filename + '.csv';
      //var filename_txt = 'https://raw.githubusercontent.com/michaelerb/misc-code/master/ts_kaufman2020_v1_0_0_tas_annual_lat_45.0_lon_0.0_with_metadata.csv';
      d3.text(filename_txt).then(plotTS);
      document.getElementById("buttons").innerHTML = '<button type="button" class="btn btn-secondary btn-sm" onclick="reset_zoom()">Reset zoom</button> <a href="'+filename_txt+'" class="btn btn-secondary btn-sm">Download CSV file</a>';

      // Create the chart variable
      var chart_new;

      // A function to make a time series
      function plotTS(data_all) {

          // Separate the metadata and the data
          var metadata = data_all.split('\n').slice(0,12);
          var metadata_dataset = metadata[0].split(': ')[1];
          var metadata_version = metadata[1].split(' ')[3];
          var metadata_season  = metadata[1].split(' ')[5];
          var metadata_latlon  = metadata[3].split(': ')[1];
          var metadata_time    = metadata[9].split(': ')[1];
          var metadata_data    = metadata[10].split(': ')[1];
          var title_txt = metadata_season.toUpperCase() + ' ' + metadata_data + ' for ' + metadata_dataset + ', ' + metadata_version + ' at ' + metadata_latlon.replace(/ deg/g,'\u00B0');
          data_csv = d3.csvParse(data_all.split('\n').slice(12).join('\n'));

          // Get metadata from the CSV file
          var data_columns = data_csv.columns;
          var age_txt = data_columns[0];
          var units_txt = data_columns[1].split('(')[1].split(')')[0];

          // Get data from the CSV file
          var time      = data_csv.map(function(data) {return data['Year (CE)']});
          var owda_mean = data_csv.map(function(data) {return data['OWDA mean (PDSI)']});

          chart_new = new Chart('ts_chart', {
              type: 'line',
              data: {
                  labels: time,
                  datasets: [{
                      label: 'OWDA mean',
                      data: owda_mean,
                      borderColor:     'rgba(255,0,0,.5)',
                      backgroundColor: 'rgba(255,0,0,.5)',
                      borderWidth: 1.5,
                      fill: false
                  }]
              },
              options: {
                  maintainAspectRatio: false,
                  animation: {
                      duration: 0
                  },
                  pointRadius: 0,
                  responsive: true,
                  plugins: {
                      title: {
                          display: true,
                          text: title_txt
                      },
                      legend: {
                          display: false,
                          position: 'bottom'
                      },
                      zoom: {
                          zoom: {
                              drag:  {enabled: true},
                              wheel: {enabled: true},
                              pinch: {enabled: true},
                              mode: 'x'
                          }
                      }
                  },
                  interaction: {
                      intersect: false,
                      mode: 'index'
                  },
                  scales: {
                      x: {
                          display: true,
                          //reverse: true,
                          min: Math.min(time),
                          max: Math.max(time),
                          includeBounds: true,
                          //maxTicksLimit: 40,
                          ticks: {
                              stepSize: 100,
                              callback: (time_value) => {
                                  return Math.floor(time_value);
                              },
                          },
                          title: {
                              display: true,
                              text: metadata_time
                          }
                      },
                      y: {
                          display: true,
                          title: {
                              display: true,
                              text: metadata_data
                          }
                      }
                  }
              }
          });
      };
      function reset_zoom() {
          chart_new.resetZoom();
      };
    </script>
  </body>